<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INKSPIRE | Enterprise Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/auto-animate/0.7.0/index.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 900: '#4c1d95' },
                        surface: '#ffffff',
                        background: '#f8fafc'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; overflow-x: hidden; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .nav-item.active {
            background: linear-gradient(90deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <div id="intro-splash" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-700 ease-out">
        <div class="relative animate-[slideUp_0.8s_ease-out]">
            <img src="LOGO.PNG" class="w-56 h-auto object-contain drop-shadow-2xl mb-8">
        </div>
        <div class="w-48 h-1 bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-primary-600 animate-[progress_1.5s_ease-in-out_forwards]" style="width: 0%"></div>
        </div>
        <style>
            @keyframes progress { 0% { width: 0%; } 100% { width: 100%; } }
        </style>
    </div>

    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-20 transition-all duration-300 fixed md:relative transform -translate-x-full md:translate-x-0 h-full" id="sidebar">
        <div class="p-6 flex items-center justify-center mb-2">
            <img src="LOGO.PNG" alt="INKSPIRE" class="w-48 h-auto object-contain transition-transform duration-500 hover:scale-105 filter hover:drop-shadow-lg cursor-pointer animate-fade-in" onclick="location.reload()">
        </div>

        <div class="p-4 space-y-1 flex-1 overflow-y-auto" id="nav-container">
            </div>

        <div class="p-4 border-t border-slate-100">
            <button onclick="App.refresh()" class="w-full flex items-center justify-center gap-2 p-3 rounded-lg text-sm font-semibold text-slate-600 hover:bg-slate-50 transition-colors">
                <i class="ph ph-arrows-clockwise"></i> Refresh Data
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        <header class="h-16 glass-panel border-b border-slate-200 flex items-center justify-between px-6 z-10">
            <button onclick="UI.toggleSidebar()" class="md:hidden p-2 text-slate-600"><i class="ph ph-list text-2xl"></i></button>
            <h2 id="page-title" class="text-lg font-bold text-slate-800 animate-fade-in">Dashboard</h2>
            <div class="flex items-center gap-4">
                <div id="sync-status" class="text-xs font-medium text-slate-400 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> Live
                </div>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-6 scroll-smooth relative">
            </div>
    </main>

    <div id="toast" class="fixed bottom-6 right-6 z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
            <i id="toast-icon" class="ph ph-check-circle text-green-400 text-xl"></i>
            <div>
                <h4 id="toast-title" class="font-bold text-sm">Success</h4>
                <p id="toast-msg" class="text-xs text-slate-300">Action completed successfully</p>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform scale-95 transition-all duration-300 overflow-hidden" id="modal-content">
            </div>
    </div>

    <script>
        /**
         * ------------------------------------------------------------------
         * CORE ARCHITECTURE
         * ------------------------------------------------------------------
         */
        
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBK4ZYB37Ke3E_bdkhY3XeScrelwSl8fYupw",
            authDomain: "inkspire-93fa1.firebaseapp.com",
            projectId: "inkspire-93fa1",
            storageBucket: "inkspire-93fa1.firebasestorage.app",
            messagingSenderId: "78600122689",
            appId: "1:78600122689:web:37da9c31db4fb36d4d71c0"
        };

        // --- STATE MANAGEMENT ---
        const State = {
            user: null,
            jobs: [],
            expenses: [],
            inventory: [],
            currentDailySheet: null, // The sheet for the selected date
            editingExpenseId: null, // NEW: Tracks which expense is being edited
            listeners: {},
            
            // Reactive Store
            set(key, value) {
                this[key] = value;
                document.dispatchEvent(new CustomEvent('stateChanged', { detail: { key, value } }));
            }
        };

        // --- FIREBASE SERVICE ---
        const DB = {
            init() {
                firebase.initializeApp(firebaseConfig);
                this.db = firebase.firestore();
                this.auth = firebase.auth();
                
                this.auth.signInAnonymously().then(() => console.log("üî• Connected"));
                this.startListeners();
            },

            startListeners() {
                // Jobs Listener
                State.listeners.jobs = this.db.collection('jobs').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    State.set('jobs', data);
                });

                // Expenses Listener
                State.listeners.expenses = this.db.collection('expenses').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    State.set('expenses', data);
                });

                // Inventory Listener
                State.listeners.inventory = this.db.collection('inventory').onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    State.set('inventory', data);
                });
            },

            // Unified Save Function for Daily Sheet
            async saveDailySheet(date, data) {
                try {
                    UI.showSyncStatus('Saving...');
                    await this.db.collection('daily_sheets').doc(date).set(data, { merge: true });
                    UI.showSyncStatus('Saved', 'success');
                } catch (e) {
                    UI.showToast('Error Saving Sheet', e.message, 'error');
                }
            },

            async loadDailySheet(date) {
                UI.showSyncStatus('Loading...');
                const doc = await this.db.collection('daily_sheets').doc(date).get();
                if (doc.exists) {
                    State.set('currentDailySheet', doc.data());
                } else {
                    State.set('currentDailySheet', null); // Fresh sheet
                }
                UI.showSyncStatus('Live', 'success');
            }
        };

        // --- UI RENDERER ---
        const UI = {
            container: document.getElementById('content-area'),
            
            routes: {
                dashboard: { label: 'Dashboard', icon: 'ph-squares-four', render: () => Views.Dashboard() },
                newJob: { label: 'New Job', icon: 'ph-plus-circle', render: () => Views.NewJob() },
                calendar: { label: 'Calendar', icon: 'ph-calendar-check', render: () => Views.Calendar() }, 
                tasks: { label: 'Tasks & Orders', icon: 'ph-check-square', render: () => Views.Tasks() },
                dailySheet: { label: 'Daily Sheet', icon: 'ph-file-text', render: () => Views.DailySheet() },
                inventory: { label: 'Inventory', icon: 'ph-package', render: () => Views.Inventory() },
                expenses: { label: 'Expenses', icon: 'ph-receipt', render: () => Views.Expenses() },
                reports: { label: 'Reports', icon: 'ph-chart-line-up', render: () => Views.Reports() }
            },

            init() {
                this.renderNav();
                this.navigate('dashboard');
                
                // State Listeners for reactivity
                document.addEventListener('stateChanged', (e) => {
                    if (this.currentRoute === 'dashboard' && ['jobs', 'expenses'].includes(e.detail.key)) this.refreshView();
                    if (this.currentRoute === 'tasks' && e.detail.key === 'jobs') this.refreshView();
                    if (this.currentRoute === 'calendar' && e.detail.key === 'jobs') App.renderCalendar();
                    if (this.currentRoute === 'inventory' && e.detail.key === 'inventory') this.refreshView();
                    if (this.currentRoute === 'expenses' && e.detail.key === 'expenses') this.refreshView();
                    if (this.currentRoute === 'dailySheet' && e.detail.key === 'currentDailySheet') Views.renderSheetData();
                });
            },

            renderNav() {
                const nav = document.getElementById('nav-container');
                nav.innerHTML = Object.entries(this.routes).map(([key, route]) => `
                    <button onclick="UI.navigate('${key}')" id="nav-${key}" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all duration-200 group">
                        <i class="ph ${route.icon} text-xl group-hover:text-primary-600 transition-colors"></i>
                        <span class="font-medium text-sm">${route.label}</span>
                    </button>
                `).join('');
            },

            navigate(routeKey) {
                this.currentRoute = routeKey;
                
                // Update Sidebar
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`nav-${routeKey}`).classList.add('active');
                
                // Update Title
                document.getElementById('page-title').textContent = this.routes[routeKey].label;
                
                // Render View with Transition
                this.container.innerHTML = `<div class="animate-slide-up">${this.routes[routeKey].render()}</div>`;
                
                // Post-render hooks
                if (routeKey === 'dashboard') Views.initCharts();
                if (routeKey === 'calendar') App.renderCalendar(); 
                if (routeKey === 'dailySheet') Views.initDailySheetListeners();
                
                // Mobile: Close sidebar
                document.getElementById('sidebar').classList.add('-translate-x-full');
            },

            refreshView() {
                // Re-renders current view without full transition
                if(this.container.firstElementChild) {
                    this.container.firstElementChild.innerHTML = this.routes[this.currentRoute].render();
                    if (this.currentRoute === 'dashboard') Views.initCharts();
                }
            },

            toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('-translate-x-full');
            },

            showToast(title, msg, type = 'success') {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toast-icon');
                
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-msg').textContent = msg;
                
                icon.className = type === 'success' 
                    ? 'ph ph-check-circle text-green-400 text-xl' 
                    : 'ph ph-warning-circle text-red-400 text-xl';

                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
            },

            showSyncStatus(msg, type='neutral') {
                const el = document.getElementById('sync-status');
                const color = type === 'success' ? 'bg-green-500' : 'bg-yellow-500';
                el.innerHTML = `<span class="w-2 h-2 rounded-full ${color} animate-pulse"></span> ${msg}`;
            },

            openModal(html) {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.innerHTML = html;
                overlay.classList.remove('hidden');
                // Trigger reflow
                void overlay.offsetWidth;
                overlay.classList.remove('opacity-0');
                content.classList.remove('scale-95');
            },

            closeModal() {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.add('opacity-0');
                content.classList.add('scale-95');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        };

        // --- VIEWS (HTML Generators) ---
        const Views = {
            Calendar() {
                return `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 h-full flex flex-col">
                        <div class="flex flex-wrap gap-4 mb-4 text-xs font-bold text-slate-600 border-b border-slate-100 pb-4">
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span> Urgent (< 2 Days)</div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-400"></span> Warning (< 5 Days)</div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Normal</div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Completed</div>
                        </div>
                        
                        <div id="calendar-wrapper" class="flex-1 bg-white font-sans text-sm"></div>
                    </div>
                `;
            },

            Dashboard() {
                const totalJobs = State.jobs.length;
                const activeJobs = State.jobs.filter(j => j.status === 'in_progress').length;
                const revenue = State.jobs.reduce((acc, j) => acc + (j.price || 0) - (j.discount || 0), 0);
                
                return `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="card-hover bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="ph ph-briefcase text-6xl text-primary-600"></i></div>
                                <p class="text-slate-500 text-sm font-medium mb-1">Active Jobs</p>
                                <h3 class="text-3xl font-bold text-slate-800">${activeJobs}</h3>
                                <div class="mt-4 flex gap-2">
                                    <button onclick="UI.navigate('newJob')" class="text-xs bg-primary-50 text-primary-700 px-3 py-1 rounded-full font-bold">+ New</button>
                                </div>
                            </div>
                            <div class="card-hover bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <p class="text-slate-500 text-sm font-medium mb-1">Total Revenue</p>
                                <h3 class="text-3xl font-bold text-green-600">Rs. ${Utils.formatMoney(revenue)}</h3>
                            </div>
                            <div class="card-hover bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <p class="text-slate-500 text-sm font-medium mb-1">Total Orders</p>
                                <h3 class="text-3xl font-bold text-slate-800">${totalJobs}</h3>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 class="font-bold text-lg mb-4">Recent Jobs</h3>
                                <div class="space-y-3">
                                    ${State.jobs.slice(0, 5).map(job => `
                                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center font-bold text-primary-600">
                                                    ${job.customer.charAt(0)}
                                                </div>
                                                <div>
                                                    <p class="font-bold text-sm text-slate-800">${job.customer}</p>
                                                    <p class="text-xs text-slate-500">${job.details.substring(0, 20)}...</p>
                                                </div>
                                            </div>
                                            <span class="text-xs font-bold px-2 py-1 rounded ${Utils.getStatusColor(job.status)}">
                                                ${Utils.formatStatus(job.status)}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 class="font-bold text-lg mb-4">Revenue Trend</h3>
                                <canvas id="dashboardChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                `;
            },

            NewJob() {
                return `
                    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-100 p-8">
                        <form id="new-job-form" onsubmit="App.submitJob(event)" class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Customer Name</label>
                                    <input type="text" name="customer" required class="w-full p-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Phone Number</label>
                                    <input type="tel" name="phone" required class="w-full p-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all">
                                </div>
                            </div>

                            <div class="border-t border-slate-100 pt-6">
                                <h3 class="font-bold text-slate-800 text-lg mb-6 flex items-center gap-2">
                                    <i class="ph ph-list-checks text-primary-600"></i> Job Requirements
                                </h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                    
                                    <div>
                                        <h4 class="font-bold text-xs text-primary-600 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">Printing & Finishing</h4>
                                        <div class="space-y-2">
                                            ${['Booklets', 'Brochures / Flyers', 'Envelopes', 'Invitation Cards', 'Laminating', 'Letterheads', 'Notepads', 'Photocopy', 'Posters / Banners', 'Printing', 'Scanning'].map(i => `
                                                <label class="flex items-center gap-2 group cursor-pointer">
                                                    <input type="checkbox" name="job_details_check" value="${i}" class="w-4 h-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 transition-all">
                                                    <span class="text-sm text-slate-600 group-hover:text-primary-700 transition-colors">${i}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="font-bold text-xs text-primary-600 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">Custom Product Printing</h4>
                                        <div class="space-y-2">
                                            ${['Badge/Button Printing', 'Calendar Printing', 'Cap Printing', 'ID Card Printing', 'Key Tag Printing', 'Mobile Cover Printing', 'Mug Printing', 'T-shirt Printing'].map(i => `
                                                <label class="flex items-center gap-2 group cursor-pointer">
                                                    <input type="checkbox" name="job_details_check" value="${i}" class="w-4 h-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 transition-all">
                                                    <span class="text-sm text-slate-600 group-hover:text-primary-700 transition-colors">${i}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="font-bold text-xs text-primary-600 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">Office & Business</h4>
                                        <div class="space-y-2">
                                            ${['Display Boards', 'Invoice Books', 'Menus', 'Presentation Folders', 'Receipt Books', 'Roll-up Banners', 'Wall Decals', 'Window Stickers'].map(i => `
                                                <label class="flex items-center gap-2 group cursor-pointer">
                                                    <input type="checkbox" name="job_details_check" value="${i}" class="w-4 h-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 transition-all">
                                                    <span class="text-sm text-slate-600 group-hover:text-primary-700 transition-colors">${i}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="font-bold text-xs text-primary-600 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">Binding & Finishing</h4>
                                        <div class="space-y-2">
                                            ${['Die Cutting', 'Saddle Stitching', 'Spiral Binding', 'Thermal Binding', 'Wire Binding'].map(i => `
                                                <label class="flex items-center gap-2 group cursor-pointer">
                                                    <input type="checkbox" name="job_details_check" value="${i}" class="w-4 h-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 transition-all">
                                                    <span class="text-sm text-slate-600 group-hover:text-primary-700 transition-colors">${i}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="font-bold text-xs text-primary-600 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">Design & Digital</h4>
                                        <div class="space-y-2">
                                            ${['Certificates', 'Graphic Design', 'Letter head creation', 'Logo Design', 'Resume/CV Design'].map(i => `
                                                <label class="flex items-center gap-2 group cursor-pointer">
                                                    <input type="checkbox" name="job_details_check" value="${i}" class="w-4 h-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500 transition-all">
                                                    <span class="text-sm text-slate-600 group-hover:text-primary-700 transition-colors">${i}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-8">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Other / Specific Instructions</label>
                                    <textarea name="job_details_other" rows="2" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all text-sm" placeholder="Any specific details not listed above..."></textarea>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-6 border-t border-slate-100">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Price (Rs.)</label>
                                    <input type="number" name="price" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Discount (Rs.)</label>
                                    <input type="number" name="discount" value="0" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Deadline</label>
                                    <input type="date" name="deadline" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all">
                                </div>
                            </div>

                            <div class="pt-4 flex justify-end">
                                <button type="submit" class="bg-primary-600 text-white px-10 py-4 rounded-xl font-bold hover:bg-primary-700 transition-all shadow-xl shadow-primary-500/30 transform hover:-translate-y-1 flex items-center gap-2">
                                    <i class="ph ph-paper-plane-right text-lg"></i> Create Job Order
                                </button>
                            </div>
                        </form>
                    </div>
                `;
            },

            Tasks() {
                return `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex gap-4">
                            <input type="text" placeholder="Search orders..." onkeyup="App.filterTasks(this.value)" class="flex-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-primary-500">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs">
                                    <tr>
                                        <th class="p-4">Customer</th>
                                        <th class="p-4">Details</th>
                                        <th class="p-4">Price</th>
                                        <th class="p-4">Deadline</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table-body" class="divide-y divide-slate-100">
                                    ${State.jobs.map(job => `
                                        <tr class="hover:bg-slate-50 transition-colors">
                                            <td class="p-4 font-bold text-slate-700">${job.customer}<br><span class="text-xs font-normal text-slate-400">${job.phone}</span></td>
                                            <td class="p-4 max-w-xs truncate">${job.details}</td>
                                            <td class="p-4 font-mono">Rs. ${Utils.formatMoney(job.price - (job.discount || 0))}</td>
                                            <td class="p-4 ${Utils.getDeadlineClass(job.deadline)}">${job.deadline}</td>
                                            <td class="p-4">
                                                <select onchange="App.updateStatus('${job.id}', this.value)" class="bg-transparent font-bold text-xs cursor-pointer focus:outline-none ${Utils.getStatusColor(job.status)} px-2 py-1 rounded">
                                                    <option value="in_progress" ${job.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                                    <option value="completed" ${job.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                    <option value="cancelled" ${job.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                </select>
                                            </td>
                                            <td class="p-4">
                                                <button onclick="App.deleteJob('${job.id}')" class="text-red-400 hover:text-red-600 transition-colors"><i class="ph ph-trash text-lg"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            DailySheet() {
                const today = new Date().toISOString().split('T')[0];
                return `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                        <div class="lg:col-span-2 space-y-6 overflow-y-auto pr-2">
                            
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between sticky top-0 z-10">
                                <div class="flex items-center gap-2">
                                    <label class="font-bold text-sm">Date:</label>
                                    <input type="date" id="sheet-date" value="${today}" onchange="App.loadSheetForDate(this.value)" class="bg-slate-50 border border-slate-200 rounded-lg p-1 text-sm">
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-xs font-bold text-slate-500">Total Customers: <span id="dsp-total-customers" class="text-slate-800 text-sm">0</span></div>
                                    <div class="text-xs font-bold bg-primary-50 text-primary-700 px-3 py-1 rounded-full animate-pulse" id="auto-save-indicator">Ready</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                <div class="bg-slate-50 p-2 border-b border-slate-100 flex justify-between items-center">
                                    <div class="flex bg-slate-200 p-1 rounded-lg">
                                        <button onclick="Views.switchSheetPage(1)" id="btn-page-1" class="px-3 py-1 text-xs font-bold rounded-md bg-white text-primary-700 shadow-sm transition-all">Page 1 (1-50)</button>
                                        <button onclick="Views.switchSheetPage(2)" id="btn-page-2" class="px-3 py-1 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition-all">Page 2 (51-100)</button>
                                    </div>
                                    <span class="text-xs font-bold uppercase text-slate-400">Sales Line Items</span>
                                </div>
                                <div id="sales-rows-container" class="p-2 space-y-1">
                                    </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                <div class="bg-slate-50 p-3 border-b border-slate-100 font-bold text-xs uppercase text-slate-500">Daily Expenses</div>
                                <div id="expenses-rows-container" class="p-2 space-y-2">
                                    </div>
                                <div class="p-2 bg-slate-50 border-t border-slate-100 text-center">
                                    <button onclick="Views.addExpenseRow()" class="text-xs font-bold text-red-600 hover:text-red-800">+ Add Expense</button>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-primary-700 text-white p-6 rounded-2xl shadow-xl">
                                <h3 class="font-bold text-lg mb-4 opacity-90">Daily Summary</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between"><span>Total Sales</span><span class="font-bold" id="dsp-total-sales">Rs. 0</span></div>
                                    <div class="flex justify-between text-red-200"><span>Expenses</span><span id="dsp-total-expenses">- Rs. 0</span></div>
                                    <div class="flex justify-between text-blue-200"><span>Banked</span><span><input type="number" id="dsp-banked" oninput="App.calculateSheetTotals()" class="w-20 bg-white/20 border-none rounded p-1 text-right text-white placeholder-white/50 text-sm focus:ring-0"></span></div>
                                    <div class="h-px bg-white/20 my-2"></div>
                                    <div class="flex justify-between text-lg font-bold"><span>Cash In Hand</span><span id="dsp-cash-hand">Rs. 0</span></div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">Cash Counter</h3>
                                <div class="space-y-2" id="cash-counter-rows">
                                    </div>
                                <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                                    <div class="text-xs font-bold text-slate-400">Total Counted</div>
                                    <div class="text-xl font-bold text-slate-800" id="cc-total">Rs. 0</div>
                                </div>
                                <div id="cc-variance" class="mt-2 text-center text-xs font-bold p-2 rounded bg-slate-100 text-slate-500">
                                    Variance: Rs. 0
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            Inventory() {
                return `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg">Inventory Items</h3>
                            <button onclick="App.addInventoryItem()" class="bg-primary-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ Add Item</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${State.inventory.length ? State.inventory.map(item => `
                                <div class="p-4 border border-slate-100 rounded-xl hover:shadow-md transition-all bg-slate-50">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-slate-700">${item.name}</h4>
                                        <button onclick="App.deleteInventory('${item.id}')" class="text-red-400 hover:text-red-600 text-xs">Remove</button>
                                    </div>
                                    <div class="mt-2 flex items-center justify-between">
                                        <span class="text-xs text-slate-500">Stock:</span>
                                        <div class="flex items-center gap-2">
                                            <button onclick="App.updateStock('${item.id}', -1)" class="w-6 h-6 rounded bg-white border border-slate-200 flex items-center justify-center text-slate-600 hover:bg-slate-100">-</button>
                                            <span class="font-mono font-bold w-8 text-center">${item.qty}</span>
                                            <button onclick="App.updateStock('${item.id}', 1)" class="w-6 h-6 rounded bg-white border border-slate-200 flex items-center justify-center text-slate-600 hover:bg-slate-100">+</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-slate-400 col-span-3 text-center py-10">No items in inventory.</p>'}
                        </div>
                    </div>
                `;
            },

            Expenses() {
                const today = new Date().toISOString().split('T')[0];
                return `
                    <div class="space-y-6 animate-slide-up">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h2 class="text-2xl font-bold text-primary-700 mb-6 flex items-center justify-between">
                                <span><i class="ph ph-receipt"></i> Shop Expenses</span>
                            </h2>
                            
                            <form id="expense-form" onsubmit="App.submitExpense(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <div class="md:col-span-1">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                                    <select name="category" class="w-full p-2 bg-white border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 text-sm">
                                        <option value="Paper Stock">üìÑ Paper Stock</option>
                                        <option value="Ink & Toner">üíß Ink & Toner</option>
                                        <option value="Maintenance">üõ†Ô∏è Maintenance</option>
                                        <option value="Utilities">üí° Utilities</option>
                                        <option value="Rent">üè† Rent</option>
                                        <option value="Salaries">üë• Salaries</option>
                                        <option value="Transport">üöö Transport</option>
                                        <option value="Office Supplies">üñáÔ∏è Office Supplies</option>
                                        <option value="Other">‚ùì Other</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                                    <input type="text" name="title" required placeholder="e.g. 500 GSM Glossy Paper (500 sheets)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 text-sm"/>
                                </div>
                                <div class="md:col-span-1">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount (Rs)</label>
                                    <input type="number" name="amount" required placeholder="0.00" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 text-sm font-semibold"/>
                                </div>
                                <div class="md:col-span-1">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Payment Method</label>
                                    <select name="method" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 text-sm">
                                        <option value="Cash">üíµ Cash</option>
                                        <option value="Bank Transfer">üè¶ Bank Transfer</option>
                                        <option value="Cheque">‚úçÔ∏è Cheque</option>
                                        <option value="Card">üí≥ Card</option>
                                    </select>
                                </div>
                                <div class="md:col-span-1">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                    <input type="date" name="date" value="${today}" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 text-sm"/>
                                </div>
                                <div class="md:col-span-2 flex items-end">
                                    <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">Add Shop Expense</button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs">
                                        <tr>
                                            <th class="p-4 w-24">Date</th>
                                            <th class="p-4 w-32">Category</th>
                                            <th class="p-4">Description</th>
                                            <th class="p-4 w-32">Method</th>
                                            <th class="p-4 text-right w-28">Amount</th>
                                            <th class="p-4 text-center w-32">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expense-body" class="divide-y divide-slate-100">
                                        ${State.expenses.map(exp => {
                                            if (State.editingExpenseId === exp.id) {
                                                // EDIT MODE ROW
                                                return `
                                                    <tr class="bg-blue-50/50 transition-colors">
                                                        <td class="p-2"><input type="date" id="edit-date-${exp.id}" value="${exp.date}" class="w-full p-1 border border-blue-200 rounded text-xs"></td>
                                                        <td class="p-2">
                                                            <select id="edit-cat-${exp.id}" class="w-full p-1 border border-blue-200 rounded text-xs">
                                                                <option value="Paper Stock" ${exp.category === 'Paper Stock' ? 'selected' : ''}>Paper Stock</option>
                                                                <option value="Ink & Toner" ${exp.category === 'Ink & Toner' ? 'selected' : ''}>Ink & Toner</option>
                                                                <option value="Maintenance" ${exp.category === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                                                                <option value="Utilities" ${exp.category === 'Utilities' ? 'selected' : ''}>Utilities</option>
                                                                <option value="Rent" ${exp.category === 'Rent' ? 'selected' : ''}>Rent</option>
                                                                <option value="Salaries" ${exp.category === 'Salaries' ? 'selected' : ''}>Salaries</option>
                                                                <option value="Transport" ${exp.category === 'Transport' ? 'selected' : ''}>Transport</option>
                                                                <option value="Office Supplies" ${exp.category === 'Office Supplies' ? 'selected' : ''}>Office Supplies</option>
                                                                <option value="Other" ${exp.category === 'Other' ? 'selected' : ''}>Other</option>
                                                            </select>
                                                        </td>
                                                        <td class="p-2"><input type="text" id="edit-title-${exp.id}" value="${exp.title}" class="w-full p-1 border border-blue-200 rounded text-xs"></td>
                                                        <td class="p-2">
                                                            <select id="edit-method-${exp.id}" class="w-full p-1 border border-blue-200 rounded text-xs">
                                                                <option value="Cash" ${exp.method === 'Cash' ? 'selected' : ''}>Cash</option>
                                                                <option value="Bank Transfer" ${exp.method === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                                                                <option value="Cheque" ${exp.method === 'Cheque' ? 'selected' : ''}>Cheque</option>
                                                                <option value="Card" ${exp.method === 'Card' ? 'selected' : ''}>Card</option>
                                                            </select>
                                                        </td>
                                                        <td class="p-2"><input type="number" id="edit-amount-${exp.id}" value="${exp.amount}" class="w-full p-1 border border-blue-200 rounded text-xs text-right font-mono"></td>
                                                        <td class="p-2 text-center flex items-center justify-center gap-2">
                                                            <button onclick="App.updateExpense('${exp.id}')" class="bg-green-500 text-white p-1 rounded hover:bg-green-600 shadow-sm" title="Save"><i class="ph ph-check text-lg"></i></button>
                                                            <button onclick="App.cancelEdit()" class="bg-slate-400 text-white p-1 rounded hover:bg-slate-500 shadow-sm" title="Cancel"><i class="ph ph-x text-lg"></i></button>
                                                        </td>
                                                    </tr>
                                                `;
                                            } else {
                                                // READ ONLY ROW
                                                return `
                                                    <tr class="hover:bg-slate-50 transition-colors group">
                                                        <td class="p-4 text-slate-600">${exp.date || 'N/A'}</td>
                                                        <td class="p-4"><span class="px-2 py-1 bg-primary-50 text-primary-700 rounded-md text-xs font-bold">${exp.category}</span></td>
                                                        <td class="p-4 font-medium text-slate-800">${exp.title}</td>
                                                        <td class="p-4 text-slate-500">${exp.method}</td>
                                                        <td class="p-4 text-right font-bold text-red-600 font-mono">Rs. ${Utils.formatMoney(exp.amount)}</td>
                                                        <td class="p-4 text-center flex justify-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onclick="App.enableEdit('${exp.id}')" class="text-blue-400 hover:text-blue-600 transition-colors p-1 rounded hover:bg-blue-50" title="Edit">
                                                                <i class="ph ph-pencil-simple text-lg"></i>
                                                            </button>
                                                            <button onclick="App.deleteExpense('${exp.id}')" class="text-slate-400 hover:text-red-600 transition-colors p-1 rounded hover:bg-red-50" title="Delete">
                                                                <i class="ph ph-trash text-lg"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            },

            Reports() {
                return `<div class="p-10 text-center text-slate-400">Reports Module Under Construction</div>`;
            },
            
            // --- Helper Methods for Views ---
            initCharts() {
                const ctx = document.getElementById('dashboardChart');
                if(!ctx) return;
                
                const data = { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Revenue', data: [12000, 19000, 3000, 5000, 2000, 30000], borderColor: '#7c3aed', tension: 0.4, fill: true, backgroundColor: 'rgba(124, 58, 237, 0.1)' }] };
                new Chart(ctx, { type: 'line', data: data, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
            },

            initDailySheetListeners() {
                // Generate 100 Rows Upfront
                const container = document.getElementById('sales-rows-container');
                container.innerHTML = '';
                
                for(let i = 1; i <= 100; i++) {
                    const pageClass = i <= 50 ? 'sheet-page-1' : 'sheet-page-2';
                    const displayStyle = i <= 50 ? '' : 'display:none';
                    
                    const div = document.createElement('div');
                    div.className = `grid grid-cols-12 gap-2 items-center group ${pageClass}`;
                    div.style.cssText = displayStyle;
                    
                    div.innerHTML = `
                        <div class="col-span-1 text-center text-xs font-bold text-slate-300 select-none">${i}</div>
                        <div class="col-span-5"><input type="text" id="desc-${i}" placeholder="Description" class="sheet-input w-full p-2 border border-slate-200 rounded text-sm focus:border-primary-500 outline-none bg-transparent" oninput="App.debouncedSaveSheet()"></div>
                        <div class="col-span-3"><input type="number" id="amt-${i}" placeholder="Amount" class="sheet-input-amt w-full p-2 border border-slate-200 rounded text-sm focus:border-primary-500 outline-none font-mono text-right" oninput="App.calculateSheetTotals()"></div>
                        <div class="col-span-3 flex gap-1 justify-center">
                            <label class="cursor-pointer"><input type="radio" name="pay-${i}" value="cash" class="peer sr-only" checked onchange="App.debouncedSaveSheet()"><span class="block w-6 h-6 rounded bg-slate-100 peer-checked:bg-green-500 peer-checked:text-white text-center text-xs leading-6 font-bold text-slate-400 transition-colors">C</span></label>
                            <label class="cursor-pointer"><input type="radio" name="pay-${i}" value="credit" class="peer sr-only" onchange="App.debouncedSaveSheet()"><span class="block w-6 h-6 rounded bg-slate-100 peer-checked:bg-yellow-500 peer-checked:text-white text-center text-xs leading-6 font-bold text-slate-400 transition-colors">R</span></label>
                            <label class="cursor-pointer"><input type="radio" name="pay-${i}" value="bank" class="peer sr-only" onchange="App.debouncedSaveSheet()"><span class="block w-6 h-6 rounded bg-slate-100 peer-checked:bg-blue-500 peer-checked:text-white text-center text-xs leading-6 font-bold text-slate-400 transition-colors">B</span></label>
                        </div>
                    `;
                    container.appendChild(div);
                }

                // Populate Cash Counter
                const ccContainer = document.getElementById('cash-counter-rows');
                const denoms = [5000, 1000, 500, 100, 50, 20, 10];
                const savedCounts = State.currentDailySheet?.cashCounts || {};

                ccContainer.innerHTML = denoms.map(d => `
                    <div class="flex items-center gap-4">
                        <div class="w-16 font-bold text-slate-500 text-xs">Rs. ${d}</div>
                        <input type="number" data-denom="${d}" value="${savedCounts[d] || ''}" oninput="App.calculateCashCounter()" class="cc-input flex-1 bg-slate-50 border border-slate-200 rounded p-1 text-center font-mono text-sm">
                        <div class="w-20 text-right font-mono text-sm font-bold text-slate-700" id="cc-sum-${d}">0</div>
                    </div>
                `).join('');

                // Initial Data Population
                this.renderSheetData();
            },

            switchSheetPage(pageNum) {
                document.querySelectorAll('.sheet-page-1').forEach(el => el.style.display = pageNum === 1 ? 'grid' : 'none');
                document.querySelectorAll('.sheet-page-2').forEach(el => el.style.display = pageNum === 2 ? 'grid' : 'none');
                
                const btn1 = document.getElementById('btn-page-1');
                const btn2 = document.getElementById('btn-page-2');
                
                if(pageNum === 1) {
                    btn1.className = "px-3 py-1 text-xs font-bold rounded-md bg-white text-primary-700 shadow-sm transition-all";
                    btn2.className = "px-3 py-1 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition-all";
                } else {
                    btn1.className = "px-3 py-1 text-xs font-bold rounded-md text-slate-500 hover:bg-white/50 transition-all";
                    btn2.className = "px-3 py-1 text-xs font-bold rounded-md bg-white text-primary-700 shadow-sm transition-all";
                }
            },

            addExpenseRow(desc='', amount='') { 
                const container = document.getElementById('expenses-rows-container');
                const div = document.createElement('div');
                div.className = "grid grid-cols-12 gap-2 items-center animate-fade-in";
                div.innerHTML = `
                    <div class="col-span-8"><input type="text" placeholder="Expense Description" value="${desc}" class="exp-desc w-full p-2 border border-slate-200 rounded text-sm focus:border-red-500 outline-none" oninput="App.debouncedSaveSheet()"></div>
                    <div class="col-span-3"><input type="number" placeholder="Amount" value="${amount}" class="exp-amt w-full p-2 border border-slate-200 rounded text-sm focus:border-red-500 outline-none font-mono text-right" oninput="App.calculateSheetTotals()"></div>
                    <div class="col-span-1 text-center"><button onclick="this.parentElement.parentElement.remove(); App.calculateSheetTotals()" class="text-red-400 hover:text-red-600"><i class="ph ph-trash"></i></button></div>
                `;
                container.appendChild(div);
            },
            
            renderSheetData() {
                const data = State.currentDailySheet || {};
                
                if(document.getElementById('dsp-banked')) {
                    document.getElementById('dsp-banked').value = data.banked || 0;
                }

                const sales = data.sales || [];
                for(let i = 1; i <= 100; i++) {
                    const rowData = sales[i-1] || {}; 
                    
                    const descInput = document.getElementById(`desc-${i}`);
                    const amtInput = document.getElementById(`amt-${i}`);
                    
                    if(descInput) descInput.value = rowData.desc || '';
                    if(amtInput) amtInput.value = rowData.amount || '';
                    
                    const payType = rowData.type || 'cash';
                    const radio = document.querySelector(`input[name="pay-${i}"][value="${payType}"]`);
                    if(radio) radio.checked = true;
                }

                const expContainer = document.getElementById('expenses-rows-container');
                if(expContainer) {
                    expContainer.innerHTML = '';
                    const expenses = data.expenses || [];
                    if(expenses.length > 0) {
                        expenses.forEach(e => this.addExpenseRow(e.desc, e.amount));
                    } else {
                        this.addExpenseRow(); 
                    }
                }
                
                App.calculateSheetTotals();
            }
        };

        // --- APP LOGIC ---
        const App = {
            init() {
                DB.init();
                UI.init();
                setTimeout(() => this.loadSheetForDate(new Date().toISOString().split('T')[0]), 500);
            },
            
            refresh() { location.reload(); },

            calendarInstance: null,
            renderCalendar() {
                const el = document.getElementById('calendar-wrapper');
                if (!el) return;

                const holidays = [
                    { title: "Duruthu Poya", start: "2025-01-13", display: "background", color: "#7c3aed" },
                    { title: "Thai Pongal", start: "2025-01-14", color: "#db2777", isHoliday: true },
                    { title: "Independence Day", start: "2025-02-04", color: "#ea580c", isHoliday: true },
                    { title: "Nawam Poya", start: "2025-02-12", display: "background", color: "#7c3aed" },
                    { title: "Mahasivarathri", start: "2025-02-26", color: "#db2777", isHoliday: true },
                    { title: "Ramadan Start", start: "2025-03-01", color: "#059669", isHoliday: true },
                    { title: "Medin Poya", start: "2025-03-13", display: "background", color: "#7c3aed" },
                    { title: "Eid al-Fitr", start: "2025-03-31", color: "#059669", isHoliday: true },
                    { title: "Bak Poya", start: "2025-04-12", display: "background", color: "#7c3aed" },
                    { title: "Sinhala & Tamil New Year", start: "2025-04-13", color: "#ea580c", isHoliday: true },
                    { title: "Good Friday", start: "2025-04-18", color: "#4b5563", isHoliday: true },
                    { title: "May Day", start: "2025-05-01", color: "#dc2626", isHoliday: true },
                    { title: "Vesak Poya", start: "2025-05-12", display: "background", color: "#7c3aed" },
                    { title: "Poson Poya", start: "2025-06-10", display: "background", color: "#7c3aed" },
                    { title: "Hajj Festival", start: "2025-06-07", color: "#059669", isHoliday: true },
                    { title: "Esala Poya", start: "2025-07-10", display: "background", color: "#7c3aed" },
                    { title: "Nikini Poya", start: "2025-08-08", display: "background", color: "#7c3aed" },
                    { title: "Prophet's Birthday", start: "2025-09-05", color: "#059669", isHoliday: true },
                    { title: "Binara Poya", start: "2025-09-07", display: "background", color: "#7c3aed" },
                    { title: "Vap Poya", start: "2025-10-06", display: "background", color: "#7c3aed" },
                    { title: "Deepavali", start: "2025-10-20", color: "#db2777", isHoliday: true },
                    { title: "Ill Poya", start: "2025-11-05", display: "background", color: "#7c3aed" },
                    { title: "Unduvap Poya", start: "2025-12-04", display: "background", color: "#7c3aed" },
                    { title: "Christmas", start: "2025-12-25", color: "#16a34a", isHoliday: true },
                    { title: "Duruthu Poya", start: "2026-01-03", display: "background", color: "#7c3aed" },
                    { title: "Thai Pongal", start: "2026-01-15", color: "#db2777", isHoliday: true },
                    { title: "Navam Poya", start: "2026-02-01", display: "background", color: "#7c3aed" },
                    { title: "Independence Day", start: "2026-02-04", color: "#ea580c", isHoliday: true },
                    { title: "Mahasivarathri", start: "2026-02-15", color: "#db2777", isHoliday: true },
                    { title: "Ramadan Start", start: "2026-02-18", color: "#059669", isHoliday: true },
                    { title: "Madin Poya", start: "2026-03-02", display: "background", color: "#7c3aed" },
                    { title: "Eid al-Fitr", start: "2026-03-21", color: "#059669", isHoliday: true },
                    { title: "Bak Poya", start: "2026-04-01", display: "background", color: "#7c3aed" },
                    { title: "Good Friday", start: "2026-04-03", color: "#4b5563", isHoliday: true },
                    { title: "Sinhala & Tamil New Year", start: "2026-04-13", color: "#ea580c", isHoliday: true },
                    { title: "May Day", start: "2026-05-01", color: "#dc2626", isHoliday: true },
                    { title: "Vesak Poya", start: "2026-05-01", display: "background", color: "#7c3aed" },
                    { title: "Eid al-Adha", start: "2026-05-28", color: "#059669", isHoliday: true },
                    { title: "Poson Poya", start: "2026-06-29", display: "background", color: "#7c3aed" },
                    { title: "Esala Poya", start: "2026-07-29", display: "background", color: "#7c3aed" },
                    { title: "Prophet's Birthday", start: "2026-08-26", color: "#059669", isHoliday: true },
                    { title: "Nikini Poya", start: "2026-08-27", display: "background", color: "#7c3aed" },
                    { title: "Binara Poya", start: "2026-09-26", display: "background", color: "#7c3aed" },
                    { title: "Vap Poya", start: "2026-10-25", display: "background", color: "#7c3aed" },
                    { title: "Deepavali", start: "2026-11-08", color: "#db2777", isHoliday: true },
                    { title: "Ill Poya", start: "2026-11-24", display: "background", color: "#7c3aed" },
                    { title: "Unduvap Poya", start: "2026-12-23", display: "background", color: "#7c3aed" },
                    { title: "Christmas", start: "2026-12-25", color: "#16a34a", isHoliday: true }
                ];

                const jobEvents = State.jobs.map(job => {
                    const deadline = new Date(job.deadline);
                    const today = new Date();
                    const diffTime = deadline - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let color = '#3b82f6'; 

                    if (job.status === 'completed') {
                        color = '#10b981'; 
                    } else if (job.status === 'cancelled') {
                        color = '#94a3b8'; 
                    } else {
                        if (diffDays <= 2) {
                            color = '#ef4444'; 
                        } else if (diffDays <= 5) {
                            color = '#fb923c'; 
                        }
                    }

                    return {
                        title: job.customer,
                        start: job.deadline,
                        backgroundColor: color,
                        borderColor: color,
                        extendedProps: { ...job, isJob: true }
                    };
                });

                const allEvents = [...holidays, ...jobEvents];

                if (this.calendarInstance) {
                    this.calendarInstance.destroy();
                }

                this.calendarInstance = new FullCalendar.Calendar(el, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    height: '100%',
                    events: allEvents,
                    navLinks: true,
                    dayMaxEvents: true,
                    nowIndicator: true,
                    eventDidMount: function(info) {
                        if (info.event.display === 'background') {
                            info.el.style.opacity = '0.15';
                            info.el.innerText = info.event.title; 
                            info.el.style.color = info.event.backgroundColor;
                            info.el.style.fontWeight = '800';
                            info.el.style.textAlign = 'center';
                            info.el.style.paddingTop = '10px';
                            info.el.style.fontSize = '0.75rem';
                            info.el.style.textTransform = 'uppercase';
                        }
                    },
                    eventClick: (info) => {
                        if (info.event.extendedProps.isHoliday || info.event.display === 'background') return;

                        const j = info.event.extendedProps;
                        UI.openModal(`
                            <div class="p-6">
                                <h3 class="text-xl font-bold text-slate-800 mb-1">${j.customer}</h3>
                                <p class="text-sm text-slate-500 mb-4">${j.phone}</p>
                                
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                                    <p class="font-medium text-slate-700">${j.details}</p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                                    <div>
                                        <p class="text-xs text-slate-400 font-bold uppercase">Deadline</p>
                                        <p class="font-bold text-slate-700">${j.deadline}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400 font-bold uppercase">Price</p>
                                        <p class="font-bold text-slate-700">Rs. ${Utils.formatMoney(j.price)}</p>
                                    </div>
                                </div>

                                <div class="flex justify-end gap-2">
                                    <button onclick="UI.closeModal()" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg">Close</button>
                                    <button onclick="UI.navigate('tasks'); UI.closeModal();" class="px-4 py-2 bg-primary-600 text-white font-bold rounded-lg hover:bg-primary-700">Go to Tasks</button>
                                </div>
                            </div>
                        `);
                    }
                });

                this.calendarInstance.render();
            },

            // Jobs
            submitJob(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const selectedOptions = Array.from(form.querySelectorAll('input[name="job_details_check"]:checked')).map(cb => cb.value);
                const otherDetails = formData.get('job_details_other');
                const finalDetails = [...selectedOptions, otherDetails].filter(Boolean).join(', ');

                if (!finalDetails) {
                    UI.showToast('Validation Error', 'Please select at least one job requirement.', 'error');
                    return;
                }

                const jobData = {
                    customer: formData.get('customer'),
                    phone: formData.get('phone'),
                    details: finalDetails,
                    price: parseFloat(formData.get('price')),
                    discount: parseFloat(formData.get('discount') || 0),
                    deadline: formData.get('deadline'),
                    status: 'in_progress',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                DB.db.collection('jobs').add(jobData).then(() => {
                    UI.showToast('Job Created', `Order for ${jobData.customer} added.`);
                    UI.navigate('tasks');
                });
            },

            updateStatus(id, status) {
                DB.db.collection('jobs').doc(id).update({ status });
                UI.showToast('Status Updated', 'Job status changed successfully.');
            },
            
            deleteJob(id) {
                if(confirm('Delete this job?')) DB.db.collection('jobs').doc(id).delete();
            },
            
            filterTasks(query) {
                const rows = document.querySelectorAll('#tasks-table-body tr');
                query = query.toLowerCase();
                rows.forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none';
                });
            },

            // Inventory
            addInventoryItem() {
                const name = prompt("Item Name:");
                if(name) {
                    DB.db.collection('inventory').add({ name, qty: 0 });
                }
            },
            
            updateStock(id, change) {
                const item = State.inventory.find(i => i.id === id);
                if(item) {
                    DB.db.collection('inventory').doc(id).update({ qty: item.qty + change });
                }
            },
            
            deleteInventory(id) {
                if(confirm('Remove item?')) DB.db.collection('inventory').doc(id).delete();
            },

            // New Expense Logic
            submitExpense(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const expenseData = {
                    category: formData.get('category'),
                    title: formData.get('title'),
                    amount: parseFloat(formData.get('amount')),
                    method: formData.get('method'),
                    date: formData.get('date'),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                DB.db.collection('expenses').add(expenseData).then(() => {
                    UI.showToast('Expense Added', 'Shop expense recorded successfully.');
                    e.target.reset();
                }).catch(err => UI.showToast('Error', err.message, 'error'));
            },

            // --- Edit Features ---
            enableEdit(id) {
                State.editingExpenseId = id;
                UI.refreshView();
            },

            cancelEdit() {
                State.editingExpenseId = null;
                UI.refreshView();
            },

            async updateExpense(id) {
                try {
                    const category = document.getElementById(`edit-cat-${id}`).value;
                    const title = document.getElementById(`edit-title-${id}`).value;
                    const method = document.getElementById(`edit-method-${id}`).value;
                    const amount = parseFloat(document.getElementById(`edit-amount-${id}`).value);
                    const date = document.getElementById(`edit-date-${id}`).value;

                    if (!title || isNaN(amount)) {
                        UI.showToast('Validation Error', 'Please check input fields.', 'error');
                        return;
                    }

                    await DB.db.collection('expenses').doc(id).update({
                        category, title, method, amount, date
                    });

                    State.editingExpenseId = null;
                    UI.showToast('Updated', 'Expense updated successfully.');
                    // UI Refresh happens automatically via Snapshot listener
                } catch (error) {
                    UI.showToast('Error', error.message, 'error');
                }
            },
            // ---------------------

            deleteExpense(id) {
                if(confirm('Delete this expense record?')) {
                    DB.db.collection('expenses').doc(id).delete()
                        .then(() => UI.showToast('Deleted', 'Expense record removed.'));
                }
            },

            // Daily Sheet Logic
            loadSheetForDate(date) {
                DB.loadDailySheet(date);
            },

            calculateSheetTotals() {
                let totalSales = 0;
                let customerCount = 0;

                for(let i = 1; i <= 100; i++) {
                    const amtInput = document.getElementById(`amt-${i}`);
                    const descInput = document.getElementById(`desc-${i}`);
                    
                    if (amtInput && descInput) {
                        const val = parseFloat(amtInput.value) || 0;
                        const desc = descInput.value.trim();
                        totalSales += val;
                        if (val > 0 || desc !== "") {
                            customerCount++;
                        }
                    }
                }
                
                const countEl = document.getElementById('dsp-total-customers');
                if(countEl) countEl.textContent = customerCount;

                let totalExpenses = 0;
                document.querySelectorAll('.exp-amt').forEach(inp => totalExpenses += (parseFloat(inp.value) || 0));

                const banked = parseFloat(document.getElementById('dsp-banked').value) || 0;
                const cashInHand = totalSales - totalExpenses - banked;
                
                document.getElementById('dsp-total-sales').textContent = `Rs. ${totalSales}`;
                document.getElementById('dsp-total-expenses').textContent = `- Rs. ${totalExpenses}`;
                document.getElementById('dsp-cash-hand').textContent = `Rs. ${cashInHand}`;
                
                this.calculateCashCounter(cashInHand);
                this.debouncedSaveSheet();
            },

            calculateCashCounter(expectedTotal = null) {
                const inputs = document.querySelectorAll('.cc-input');
                let total = 0;
                inputs.forEach(input => {
                    const d = parseFloat(input.dataset.denom);
                    const count = parseFloat(input.value) || 0;
                    const sub = d * count;
                    total += sub;
                    document.getElementById(`cc-sum-${d}`).textContent = sub;
                });
                
                document.getElementById('cc-total').textContent = `Rs. ${total}`;
                
                if (expectedTotal === null) {
                   const cashText = document.getElementById('dsp-cash-hand').textContent;
                   expectedTotal = parseFloat(cashText.replace(/[^0-9.-]+/g,"")) || 0;
                }
                
                const variance = total - expectedTotal;
                const vEl = document.getElementById('cc-variance');
                vEl.textContent = `Variance: Rs. ${variance}`;
                vEl.className = Math.abs(variance) < 1 
                    ? "mt-2 text-center text-xs font-bold p-2 rounded bg-green-100 text-green-700" 
                    : "mt-2 text-center text-xs font-bold p-2 rounded bg-red-100 text-red-700";
                    
                this.debouncedSaveSheet();
            },

            saveTimer: null,
            debouncedSaveSheet() {
                const indicator = document.getElementById('auto-save-indicator');
                if(indicator) indicator.textContent = "Typing...";
                clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(() => {
                    this.gatherAndSaveSheet();
                }, 1000);
            },

            gatherAndSaveSheet() {
                const dateEl = document.getElementById('sheet-date');
                if(!dateEl) return;
                const date = dateEl.value;
                const sales = [];
                
                for(let i = 1; i <= 100; i++) {
                    const desc = document.getElementById(`desc-${i}`).value;
                    const amount = document.getElementById(`amt-${i}`).value; 
                    const checked = document.querySelector(`input[name="pay-${i}"]:checked`);
                    
                    sales.push({ 
                        desc: desc, 
                        amount: amount, 
                        type: checked ? checked.value : 'cash' 
                    });
                }

                const expenses = [];
                const expRows = document.getElementById('expenses-rows-container').children;
                for(let row of expRows) {
                    const descInput = row.querySelector('.exp-desc');
                    const amtInput = row.querySelector('.exp-amt');
                    if(descInput && amtInput) {
                        const desc = descInput.value;
                        const amount = parseFloat(amtInput.value) || 0;
                        if(desc || amount) expenses.push({desc, amount});
                    }
                }

                const cashCounts = {};
                document.querySelectorAll('.cc-input').forEach(i => {
                    if(i.value) cashCounts[i.dataset.denom] = i.value;
                });

                const data = {
                    sales, 
                    expenses,
                    banked: parseFloat(document.getElementById('dsp-banked').value) || 0,
                    cashCounts,
                    totalCustomers: parseInt(document.getElementById('dsp-total-customers').textContent) || 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                DB.saveDailySheet(date, data);
                const indicator = document.getElementById('auto-save-indicator');
                if(indicator) indicator.textContent = "Saved";
            }
        };

        // --- UTILS ---
        const Utils = {
            formatMoney: (n) => (n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            getStatusColor: (status) => ({
                'in_progress': 'bg-yellow-100 text-yellow-700',
                'completed': 'bg-green-100 text-green-700',
                'cancelled': 'bg-red-100 text-red-700'
            })[status] || 'bg-slate-100',
            formatStatus: (s) => s.replace('_', ' ').toUpperCase(),
            getDeadlineClass: (dateStr) => {
                if (!dateStr) return '';
                const days = Math.ceil((new Date(dateStr) - new Date()) / (1000 * 60 * 60 * 24));
                return days < 0 ? 'text-red-600 font-bold' : days < 3 ? 'text-yellow-600 font-bold' : 'text-slate-600';
            }
        };

        // --- BOOTSTRAP ---
        App.init();

        // Intro Animation Logic
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('intro-splash');
                if(splash) {
                    splash.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => splash.remove(), 800);
                }
            }, 1800); // Logo stays visible for 1.8 seconds
        });

    </script>
</body>
</html>
